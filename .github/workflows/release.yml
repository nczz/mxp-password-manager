name: Create Release

on:
  push:
    tags:
      - 'v*'  # 觸發條件：推送 v 開頭的標籤 (例如 v3.3.0, v3.4.0)

permissions:
  contents: write  # 需要寫入權限來建立 Release 和上傳檔案

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          coverage: none

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create plugin ZIP
        id: create_zip
        run: |
          # 建立臨時目錄
          mkdir -p release_temp

          # 複製外掛檔案（排除 .git, .github, node_modules 等）
          rsync -av \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='node_modules/' \
            --exclude='.gitignore' \
            --exclude='*.log' \
            --exclude='*.md' \
            --exclude='tests/' \
            --exclude='.DS_Store' \
            --exclude='release_temp/' \
            ./ release_temp/mxp-password-manager/

          # 進入臨時目錄並建立 ZIP 檔案（確保路徑結構正確）
          cd release_temp
          zip -r "${GITHUB_WORKSPACE}/mxp-password-manager-${{ steps.get_version.outputs.version }}.zip" mxp-password-manager/

          # 清理臨時目錄
          cd "${GITHUB_WORKSPACE}"
          rm -rf release_temp

          echo "zip_file=mxp-password-manager-${{ steps.get_version.outputs.version }}.zip" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        run: |
          # 讀取 RELEASE_NOTES.md 中對應版本的內容
          version="${{ steps.get_version.outputs.version }}"

          # 提取指定版本的 release notes
          awk -v ver="Version $version" '
            $0 == "# " ver { in_section=1; next }
            /^# Version/ && in_section && $0 != "# " ver { exit }
            in_section { print }
          ' RELEASE_NOTES.md > release_notes.md

          # 如果沒有找到版本，使用預設模板
          if [ ! -s release_notes.md ]; then
            cat > release_notes.md << EOF
          ## MXP Password Manager $version

          此版本包含以下更新和改進。

          請參閱 [RELEASE_NOTES.md](https://github.com/${{ github.repository }}/blob/main/RELEASE_NOTES.md) 以獲取完整更新日誌。
          EOF
          fi

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: MXP Password Manager ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: ${{ steps.create_zip.outputs.zip_file }}
          draft: false
          prerelease: false
          generate_release_notes: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        run: |
          rm -f release_notes.md
          rm -f ${{ steps.create_zip.outputs.zip_file }}
