name: Create Release

on:
  push:
    tags:
      - 'v*'  # è§¸ç™¼æ¢ä»¶ï¼šæ¨é€ v é–‹é ­çš„æ¨™ç±¤ (ä¾‹å¦‚ v3.3.0, v3.4.0)

permissions:
  contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä¾†å»ºç«‹ Release å’Œä¸Šå‚³æª”æ¡ˆ

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          coverage: none

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create plugin ZIP
        id: create_zip
        run: |
          # å»ºç«‹è‡¨æ™‚ç›®éŒ„
          mkdir -p release_temp/mxp-password-manager

          # è¤‡è£½å¤–æ›æª”æ¡ˆï¼ˆæ’é™¤ .git, .github, node_modules ç­‰ï¼‰
          rsync -av \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='node_modules/' \
            --exclude='.gitignore' \
            --exclude='*.log' \
            --exclude='*.md' \
            --exclude='tests/' \
            --exclude='.DS_Store' \
            --exclude='release_temp/' \
            ./ release_temp/mxp-password-manager/

          # ä½¿ç”¨ GITHUB_WORKSPACE çµ•å°è·¯å¾‘å»ºç«‹ ZIP æª”æ¡ˆ
          zip -r "${GITHUB_WORKSPACE}/mxp-password-manager-${{ steps.get_version.outputs.version }}.zip" release_temp/mxp-password-manager/

          # æ¸…ç†è‡¨æ™‚ç›®éŒ„
          rm -rf release_temp

          echo "zip_file=mxp-password-manager-${{ steps.get_version.outputs.version }}.zip" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        run: |
          # å»ºç«‹ release notes
          cat > release_notes.md << 'EOF'
          ## MXP Password Manager ${{ steps.get_version.outputs.version }}

          æ­¤ç‰ˆæœ¬åŒ…å«ä»¥ä¸‹æ›´æ–°å’Œæ”¹é€²ï¼š

          ### ğŸš€ æ–°åŠŸèƒ½
          - [åœ¨æ­¤æè¿°æ–°åŠŸèƒ½]

          ### ğŸ› Bug ä¿®å¾©
          - [åœ¨æ­¤æè¿°ä¿®å¾©çš„å•é¡Œ]

          ### âš¡ æ”¹é€²
          - [åœ¨æ­¤æè¿°æ”¹é€²é …ç›®]

          ### ğŸ“ æ›´æ–°èªªæ˜
          - æ­¤æ¬¡æ›´æ–°åŒ…å«è³‡æ–™åº«é·ç§»ï¼Œè«‹å…ˆå‚™ä»½è³‡æ–™åº«
          - æ›´æ–°å¾Œè«‹æª¢æŸ¥æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œ

          ---
          ## ä¸‹è¼‰å®‰è£

          ### æ–¹æ³•ä¸€ï¼šWordPress è‡ªå‹•æ›´æ–°
          1. é€²å…¥ WordPress ç®¡ç†å¾Œå° > å¤–æ›
          2. é»æ“Šã€Œæ›´æ–°ã€æŒ‰éˆ•
          3. ç­‰å¾…æ›´æ–°å®Œæˆ

          ### æ–¹æ³•äºŒï¼šæ‰‹å‹•å®‰è£
          1. ä¸‹è¼‰ä¸‹æ–¹ ZIP æª”æ¡ˆ
          2. è§£å£“ç¸®å¾Œä¸Šå‚³è‡³ `/wp-content/plugins/` ç›®éŒ„
          3. è¦†è“‹èˆŠç‰ˆæœ¬æª”æ¡ˆ
          4. é€²å…¥å¾Œå°å•Ÿç”¨å¤–æ›

          ---
          ## å®Œæ•´æ›´æ–°æ—¥èªŒ

          è«‹åƒé–± [RELEASE_NOTES.md](https://github.com/${{ github.repository }}/blob/main/RELEASE_NOTES.md)

          ---
          ## ç³»çµ±éœ€æ±‚

          - WordPress 5.0+
          - PHP 7.4+
          - MySQL 5.7+ / MariaDB 10.3+
          - OpenSSL æ“´å……

          ## æ”¯æ´

          å¦‚é‡å•é¡Œï¼Œè«‹è‡³ [GitHub Issues](https://github.com/${{ github.repository }}/issues) å›å ±ã€‚

          ## æˆæ¬Š

          GPL v2 or later

          EOF

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: MXP Password Manager ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: |
            ${{ steps.create_zip.outputs.zip_file }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        run: |
          rm -f release_notes.md
          rm -f ${{ steps.create_zip.outputs.zip_file }}
